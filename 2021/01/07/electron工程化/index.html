<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>electron工程化 | 王美的个人博客</title><meta name="description" content="工程化安全性在这里讨论安全性，我们主要分为两种，一种是加载应用内资源，一种是加载远程资源。 对于加载应用内资源代码我们是可控的，需要注意的安全问题和通常的网站差不多，防范XSS攻击等。 而很多情况下，在我们的应用中可能需要加载远程站点（合作网站、用户发送的链接，由第三方开发的小程序等），对于这些很多场景下不可控的代码资源，如果直接给他们所有的访问权限，后果将不可控，因此我们着重讨论加载远程资源可能"><meta name="keywords" content="electron"><meta name="author" content="王美"><meta name="copyright" content="王美"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hard-workingrookie.github.io/2021/01/07/electron%E5%B7%A5%E7%A8%8B%E5%8C%96/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="electron工程化"><meta property="og:url" content="https://hard-workingrookie.github.io/2021/01/07/electron%E5%B7%A5%E7%A8%8B%E5%8C%96/"><meta property="og:site_name" content="王美的个人博客"><meta property="og:description" content="工程化安全性在这里讨论安全性，我们主要分为两种，一种是加载应用内资源，一种是加载远程资源。 对于加载应用内资源代码我们是可控的，需要注意的安全问题和通常的网站差不多，防范XSS攻击等。 而很多情况下，在我们的应用中可能需要加载远程站点（合作网站、用户发送的链接，由第三方开发的小程序等），对于这些很多场景下不可控的代码资源，如果直接给他们所有的访问权限，后果将不可控，因此我们着重讨论加载远程资源可能"><meta property="og:image" content="http://tvshow.date/images/1504170750981724.jpg"><meta property="article:published_time" content="2021-01-07T07:30:05.000Z"><meta property="article:modified_time" content="2021-03-09T14:07:46.598Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime: '',
  last_push_date: {"zeroDay":"今天","suffix":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
      const now = new Date()
      const expiryDay = ttl * 86400000
      const item = {
        value: value,
        expiry: now.getTime() + expiryDay,
      }
      localStorage.setItem(key, JSON.stringify(item))
    },
  
  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-03-09 22:07:46'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="王美的个人博客" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">22</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/Share/"><i class="fa-fw fas fa-heart"></i><span> Share</span></a></div><div class="menus_item"><a class="site-page" href="/Diary/"><i class="fa-fw fas fa-paint-brush"></i><span> Diary</span></a></div><div class="menus_item"><a class="site-page" href="/About/"><i class="fa-fw fas fa-info"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">工程化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text">安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%8F%91%E9%80%81%E7%9A%84%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.1.</span> <span class="toc-text">用户发送的链接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E7%BB%B4%E6%8A%A4%E7%AB%99%E7%82%B9%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">后端维护站点黑名单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%B3%BB%E7%BB%9F%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">通过系统浏览器打开</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87webPreferences%E9%99%90%E5%88%B6API%E8%AE%BF%E9%97%AE"><span class="toc-number">1.1.2.</span> <span class="toc-text">通过webPreferences限制API访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86API"><span class="toc-number">1.1.3.</span> <span class="toc-text">代理API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9API%E5%81%9A%E5%AE%8C%E5%85%A8%E7%9A%84%E5%B0%81%E8%A3%85"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">对API做完全的封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87remote-require%E4%BA%8B%E4%BB%B6%E5%81%9A%E4%BB%A3%E7%90%86%E5%92%8C%E6%94%BE%E8%A1%8C"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">通过remote-require事件做代理和放行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E5%AF%BC%E8%88%AA"><span class="toc-number">1.1.4.</span> <span class="toc-text">限制导航</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E6%96%B0%E7%AA%97%E5%8F%A3%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.1.5.</span> <span class="toc-text">限制新窗口的创建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B4%A9%E6%BA%83%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text">崩溃收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%86%B5%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">情况模拟</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Renderer%E8%BF%9B%E7%A8%8B%E4%B8%BB%E5%8A%A8push%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">Renderer进程主动push错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Renderer%E8%BF%9B%E7%A8%8B%E8%A2%AB%E5%8A%A8%E8%A7%A6%E5%8F%91%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">2. Renderer进程被动触发错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Renderer%E8%BF%9B%E7%A8%8Bcrash%E4%BA%86"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">Renderer进程crash了</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91"><span class="toc-number">1.3.</span> <span class="toc-text">开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAElectron-App"><span class="toc-number">1.3.1.</span> <span class="toc-text">快速新建一个Electron App</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%BC%8F%E5%BC%80%E5%A7%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">正式开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Webpack%E6%9D%A5%E7%BC%96%E8%AF%91%E6%88%91%E4%BB%AC%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">使用Webpack来编译我们的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E4%B8%BB%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">调试主进程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8chrome%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.2.2.1.</span> <span class="toc-text">使用chrome调试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8vscode%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.2.2.2.</span> <span class="toc-text">使用vscode调试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8webstorm%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.2.2.3.</span> <span class="toc-text">使用webstorm调试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%B8%B2%E6%9F%93%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">调试渲染进程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E5%BC%80%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">1.3.2.3.1.</span> <span class="toc-text">打开控制台</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0preload"><span class="toc-number">1.3.2.3.2.</span> <span class="toc-text">添加preload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%96%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">流程完善</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%E5%AE%8C%E5%96%84"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">启动命令完善</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8React%E5%81%9A%E6%B8%B2%E6%9F%93%E8%BF%9B%E7%A8%8B%E5%BC%80%E5%8F%91"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">使用React做渲染进程开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%99devtools%E6%B7%BB%E5%8A%A0plugins"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">给devtools添加plugins</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.4.</span> <span class="toc-text">相关文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8C%85"><span class="toc-number">1.4.</span> <span class="toc-text">打包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%89%93%E5%8C%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.1.</span> <span class="toc-text">基本打包配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0build%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">添加build命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85electron-builder"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">安装electron-builder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">添加配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E6%B7%BB%E5%8A%A0%E6%89%93%E5%8C%85%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">1.4 添加打包命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D"><span class="toc-number">1.4.2.</span> <span class="toc-text">代码签名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MacOS%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">MacOS代码签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">Windows代码签名</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E8%AF%A6%E7%BB%86%E7%9A%84%E5%B9%B3%E5%8F%B0target%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.</span> <span class="toc-text">更详细的平台target配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MacOS%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">MacOS配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">Windows配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E7%9A%84%E6%8F%92%E4%BB%B6%E6%89%93%E5%8C%85"><span class="toc-number">1.4.4.</span> <span class="toc-text">多平台的插件打包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E6%8F%92%E4%BB%B6%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">找到插件执行文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">添加编译配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">加载插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E7%9A%84-Pepper-Flash-%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.4.4.</span> <span class="toc-text">加载系统安装的 Pepper Flash 插件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%A4%9A%E7%8E%AF%E5%A2%83%E6%89%93%E5%8C%85%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">1.4.5.</span> <span class="toc-text">创建多平台多环境打包的命令行工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">1.5.</span> <span class="toc-text">自动更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Eelectron-updater"><span class="toc-number">1.5.1.</span> <span class="toc-text">关于electron-updater</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">适用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E7%9A%84API"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">提供的API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E7%9A%84%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">提供的事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%9B%B4%E6%96%B0%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">一个简单的更新示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.2.</span> <span class="toc-text">更新服务的设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">需要实现的功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">更新流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">接口设计</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(http://tvshow.date/images/1504170750981724.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">王美的个人博客</a></span><span class="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/Share/"><i class="fa-fw fas fa-heart"></i><span> Share</span></a></div><div class="menus_item"><a class="site-page" href="/Diary/"><i class="fa-fw fas fa-paint-brush"></i><span> Diary</span></a></div><div class="menus_item"><a class="site-page" href="/About/"><i class="fa-fw fas fa-info"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">electron工程化</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-07T07:30:05.000Z" title="发表于 2021-01-07 15:30:05">2021-01-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-09T14:07:46.598Z" title="更新于 2021-03-09 22:07:46">2021-03-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/electron/">electron</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="工程化"><a href="#工程化" class="headerlink" title="工程化"></a>工程化</h1><h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>在这里讨论安全性，我们主要分为两种，一种是加载<strong>应用内</strong>资源，一种是加载<strong>远程</strong>资源。</p>
<p>对于加载应用内资源代码我们是可控的，需要注意的安全问题和通常的网站差不多，防范XSS攻击等。</p>
<p>而很多情况下，在我们的应用中可能需要加载远程站点（合作网站、用户发送的链接，由第三方开发的小程序等），对于这些很多场景下不可控的代码资源，如果直接给他们所有的访问权限，后果将不可控，因此我们着重讨论加载远程资源可能的问题以及解决方法。</p>
<h3 id="用户发送的链接"><a href="#用户发送的链接" class="headerlink" title="用户发送的链接"></a>用户发送的链接</h3><p>用户发送的内容并不可控，在这里我们需要<strong>多重拦截</strong>做保障。</p>
<h4 id="后端维护站点黑名单"><a href="#后端维护站点黑名单" class="headerlink" title="后端维护站点黑名单"></a>后端维护站点黑名单</h4><p>由后端维护一个站点黑名单，用户发送的每个链接在打开前都请求一次接口，判断到如果是色情网站钓鱼网站等不合法站点，直接提醒用户不要打开。</p>
<h4 id="通过系统浏览器打开"><a href="#通过系统浏览器打开" class="headerlink" title="通过系统浏览器打开"></a>通过系统浏览器打开</h4><p>可以通过<code>shell.openExternal</code>通过浏览器打开第三方站点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @@code-renderer:runner</span></span><br><span class="line"><span class="comment">// @@code-props: &#123; height: &#x27;120px&#x27;, hideRight: true &#125;</span></span><br><span class="line"><span class="keyword">const</span> &#123; shell &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line">shell.openExternal(<span class="string">&#x27;https://github.com&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>但是使用这个方法需要注意两点：</p>
<p>1.<strong>openExternal不只能打开http链接</strong></p>
<p>  <code>openExternal</code>方法是是通过系统的默认应用打开给定的外部协议URL，比如说打开下面这段url会打开邮件应用写邮件，非http协议的链接只要有对应的处理程序都会打开。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @@code-renderer:runner</span></span><br><span class="line"><span class="comment">// @@code-props: &#123; height: &#x27;120px&#x27;, hideRight: true &#125;</span></span><br><span class="line"><span class="keyword">const</span> &#123; shell &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line">shell.openExternal(<span class="string">&#x27;mailto:somebody@gmail.com?subject=I love you&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>使用此API时需要注意先判断URL地址的协议。</p>
<p>2.<strong>打开http链接仍应先判断风险</strong> </p>
<p>  即使是http协议，通过浏览器打开前，最好也能先判断是否有风险，否则相当于将网站的安全性判断责任转嫁给了浏览器，用户仍然有不小心打开钓鱼网站的风险。</p>
<h3 id="通过webPreferences限制API访问"><a href="#通过webPreferences限制API访问" class="headerlink" title="通过webPreferences限制API访问"></a>通过webPreferences限制API访问</h3><p>如果需要在Electron应用中打开无法确定安全性的链接，我们可以对打开该链接的窗口设置更为严格的<code>webPreferences</code>选项以限制其能访问到的api和内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> win = <span class="keyword">new</span> BrowserWindow(&#123;<span class="attr">webPreferences</span>: &#123;</span><br><span class="line">  <span class="comment">// 是否集成node环境</span></span><br><span class="line">  nodeIntegration: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// 在沙盒中运行渲染进程</span></span><br><span class="line">  sandbox: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 是否启用remote模块</span></span><br><span class="line">  enableRemoteModule: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// 启用同源策略</span></span><br><span class="line">  webSecurity: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 是否允许运行http协议加载的内容</span></span><br><span class="line">  allowRunningInsecureContent: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// 在独立JavaScript环境中运行Electron API和指定的preload脚本</span></span><br><span class="line">  contextIsolation: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 是否允许使用原生的window.open()</span></span><br><span class="line">  nativeWindowOpen: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// 是否启用webview标签</span></span><br><span class="line">  webviewTag: <span class="literal">false</span>,</span><br><span class="line">&#125;&#125;)</span><br><span class="line">win.loadURL(<span class="string">&#x27;https://github.com&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>更详细的参数设置可以参考<a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/api/browser-window#new-browserwindowoptions">文档</a></p>
<p>上面的选项进行了十分严格的限制，无node环境，不允许<code>window.open</code>，不允许加载非https链接，在独立JS环境运行等等，安全性是够了，但是带来的问题就是，如果遇到业务需要使用API怎么办？</p>
<p>比如说由第三方开发的小程序，可能会需要获取一些Node或Electron的api，但是又要确保安全性。</p>
<p>这种情况下就需要代理一些Node和Electron的api了</p>
<h3 id="代理API"><a href="#代理API" class="headerlink" title="代理API"></a>代理API</h3><p>这里我们主要讨论两种方式。</p>
<h4 id="对API做完全的封装"><a href="#对API做完全的封装" class="headerlink" title="对API做完全的封装"></a>对API做完全的封装</h4><p>将方法在preload中封装好（禁用node集成不影响preload），然后挂载到Window上供其调用，比如在<br>中通过下面的代码可以提供API读取文件内容，但不允许写入文件等操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> JSBridge = &#123;</span><br><span class="line">  <span class="comment">// 只提供读取方法，不提供写入</span></span><br><span class="line">  readFile: <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">// 做一些路径规则判断，是否允许访问</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="regexp">/regexp-to-test-path/</span>.test(path)) reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`not allowed path <span class="subst">$&#123;path&#125;</span>`</span>))</span><br><span class="line">      fs.readFile(path, <span class="function">(<span class="params">err, data</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err) reject(err)</span><br><span class="line">        resolve(data)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.JSBridge = JSBridge</span><br></pre></td></tr></table></figure>

<h4 id="通过remote-require事件做代理和放行"><a href="#通过remote-require事件做代理和放行" class="headerlink" title="通过remote-require事件做代理和放行"></a>通过<code>remote-require</code>事件做代理和放行</h4><p>监听<a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/api/app#event-remote-require">app的remote-require事件</a>，根据模块名称做过滤和放行，也可以返回封装好的代理模块。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readOnlyFsProxy = <span class="built_in">require</span>(<span class="comment">/* ... */</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> allowedModules = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">&#x27;crypto&#x27;</span>])</span><br><span class="line"><span class="keyword">const</span> proxiedModules = <span class="keyword">new</span> <span class="built_in">Map</span>([<span class="string">&#x27;fs&#x27;</span>, readOnlyFsProxy])</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;remote-require&#x27;</span>, <span class="function">(<span class="params">event, webContents, moduleName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (proxiedModules.has(moduleName)) &#123;</span><br><span class="line">    event.returnValue = proxiedModules.get(moduleName)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!allowedModules.has(moduleName)) &#123;</span><br><span class="line">    event.preventDefault()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="限制导航"><a href="#限制导航" class="headerlink" title="限制导航"></a>限制导航</h3><p>在浏览器要开始导航时会触发<code>will-navigate</code>事件，我们可以在事件回调中判断url是否为站内链接，如果非站内链接可以调用<code>event.preventDefault()</code>阻止这次导航。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> browserWindow = <span class="keyword">new</span> BrowserWindow()</span><br><span class="line">browserWindow.webContents.on(<span class="string">&#x27;will-navigate&#x27;</span>, <span class="function">(<span class="params">event, url</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 判断链接域名</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="regexp">/google.com?/</span>.test(<span class="keyword">new</span> URL(url).origin))&#123;</span><br><span class="line">    event.preventDefault()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">browserWindow.loadURL(<span class="string">&#x27;https://google.com&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>执行上面的代码，会发现打开的窗口中可以进行搜索，但是无法进入搜索出的第三方页面。</p>
<h3 id="限制新窗口的创建"><a href="#限制新窗口的创建" class="headerlink" title="限制新窗口的创建"></a>限制新窗口的创建</h3><p>新窗口的创建主要有几种形式：</p>
<ol>
<li>站点资源，可能会通过window.open(), a标签的target=_blank等方式打开新窗口；</li>
<li>用户通过Command/Ctrl+鼠标单击，右键菜单等方式打开新窗口；</li>
</ol>
<p>通过监听<code>new-window</code>事件可以判断url和打开方式，然后通过<code>event.preventDefault()</code>来阻止创建新窗口</p>
<p>下面的代码阻止了command+click和点击a标签target=_blank的方式打开新窗口:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserWindow, dialog &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> browserWindow = <span class="keyword">new</span> BrowserWindow()</span><br><span class="line">browserWindow.webContents.on(<span class="string">&#x27;new-window&#x27;</span>, <span class="function">(<span class="params">event, url, frameName, disposition</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// disposition字段的相关解释:</span></span><br><span class="line">  <span class="comment">// new-window : open调用</span></span><br><span class="line">  <span class="comment">// background-tab: command+click</span></span><br><span class="line">  <span class="comment">// foreground-tab: 右键点击新标签打开或点击a标签target _blank打开</span></span><br><span class="line">  <span class="comment">// electron文档: 文档：https://www.electronjs.org/docs/api/web-contents#webcontents</span></span><br><span class="line">  <span class="comment">// github源码: github源码： https://github.com/electron/electron/blob/72a089262e31054eabd342294ccdc4c414425c99/shell/browser/api/electron_api_web_contents.cc</span></span><br><span class="line">  <span class="comment">// chrome 源码： https://chromium.googlesource.com/chromium/src/+/66.0.3359.158/ui/base/mojo/window_open_disposition_struct_traits.h</span></span><br><span class="line">  <span class="keyword">if</span> (disposition === <span class="string">&#x27;background-tab&#x27;</span> || disposition === <span class="string">&#x27;foreground-tab&#x27;</span>) &#123;</span><br><span class="line">    dialog.showMessageBox(&#123;<span class="attr">message</span>: <span class="string">`not allowed. url: <span class="subst">$&#123;url&#125;</span>, disposition: <span class="subst">$&#123;disposition&#125;</span>`</span>&#125;)</span><br><span class="line">    event.preventDefault()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">browserWindow.loadURL(<span class="string">&#x27;https://google.com&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>尝试一下：修改上面的代码，看看不同的disposition分别适用什么场景</p>
<h2 id="崩溃收集"><a href="#崩溃收集" class="headerlink" title="崩溃收集"></a>崩溃收集</h2><p>开发electron项目时，经常会遇到APP崩溃的情况，如果APP端没有对应的日志记录，那开发就无法掌握APP的崩溃情况了，也不好做分析。</p>
<p>目前我们选用的是开源项目<a target="_blank" rel="noopener" href="https://sentry.io/">Sentry</a>,它用来记录crash日志，它也有统计模块，也能私有化部署，基本上开箱就能用</p>
<p><img src= "/img/loading.gif" data-lazy-src="http://mei160.cn/images/sentry.png" alt="sentry"></p>
<h3 id="情况模拟"><a href="#情况模拟" class="headerlink" title="情况模拟"></a>情况模拟</h3><h4 id="Renderer进程主动push错误信息"><a href="#Renderer进程主动push错误信息" class="headerlink" title="Renderer进程主动push错误信息"></a>Renderer进程主动push错误信息</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.$EB.ipcRenderer.send(<span class="string">&#x27;renderer.error&#x27;</span>, &#123;</span><br><span class="line">  message: <span class="string">&#x27;renderer.error&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>触发的<a target="_blank" rel="noopener" href="https://sentry.io/share/issue/76069b04b4aa4cc0ba99c2e74fceb8fc/">sentry 错误日志(可能需要翻墙)</a></p>
<h4 id="2-Renderer进程被动触发错误信息"><a href="#2-Renderer进程被动触发错误信息" class="headerlink" title="2. Renderer进程被动触发错误信息"></a>2. Renderer进程被动触发错误信息</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Error triggered in renderer process&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这不会触发sentry信息</p>
<h4 id="Renderer进程crash了"><a href="#Renderer进程crash了" class="headerlink" title="Renderer进程crash了"></a>Renderer进程crash了</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">window</span>.$EB.crash()</span><br></pre></td></tr></table></figure>

<p>触发的<a target="_blank" rel="noopener" href="https://sentry.io/share/issue/05a5ec366a194f36b2293b453cdec25c/">sentry crash日志(可能需要翻墙)</a></p>
<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><h3 id="快速新建一个Electron-App"><a href="#快速新建一个Electron-App" class="headerlink" title="快速新建一个Electron App"></a>快速新建一个Electron App</h3><p>新建一个工作目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir my-app &amp;&amp; cd my-app</span><br></pre></td></tr></table></figure>
<p>初始化<strong>package.json</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn init</span><br></pre></td></tr></table></figure>
<p>安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add electron -D</span><br></pre></td></tr></table></figure>
<p>新建index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    html, body &#123;</span><br><span class="line">      background-color: antiquewhite;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>新建index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app, BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow()</span><br><span class="line">  <span class="built_in">window</span>.loadFile(path.resolve(__dirname, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在package.json中添加启动命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;start&quot;: &quot;electron .&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>执行启动命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<p>显示效果如下</p>
<p><img src= "/img/loading.gif" data-lazy-src="http://mei160.cn/images/quick_start_electron_app.png" alt="quick start electron app"></p>
<p>这样，一个十分简单的Electron App就完成了。</p>
<h3 id="正式开始"><a href="#正式开始" class="headerlink" title="正式开始"></a>正式开始</h3><p>刚刚的项目虽然已经能够启动来，但还有些简单，对于需求和业务复杂的项目来说还有很多不足。</p>
<p>比如，主进程和渲染进程改如何调试？我想用最新的ES特性该怎么做？想用TypeScript该怎么配置？想用React，Vue，Angular来写UI呢？</p>
<p>接下来我们将一一解决这些问题。</p>
<h4 id="使用Webpack来编译我们的代码"><a href="#使用Webpack来编译我们的代码" class="headerlink" title="使用Webpack来编译我们的代码"></a>使用Webpack来编译我们的代码</h4><p>首先调整一下目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app                                 </span><br><span class="line">│   └── index.js                        主进程入口文件</span><br><span class="line">├── build                               构建相关的脚本和配置</span><br><span class="line">│   └── webpack.config.js</span><br><span class="line">├── output                              编译结果输出目录</span><br><span class="line">└── src                                 </span><br><span class="line">    └── index.html                      渲染进程入口文件 </span><br></pre></td></tr></table></figure>

<p>我们这里选择webpack作为构建工具。</p>
<p>Electron本身的TypeScript类型声明文件很齐全，开发体验不错，因此这里选择TypeScript作为主要开发语言。</p>
<p>首先安装必要的依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D webpack webpack-cli webpack-merge typescript awesome-typescript-loader</span><br></pre></td></tr></table></figure>

<p>在build目录添加webpack.config.base.js，配置如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.jsx&#x27;</span>],</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="string">&#x27;app&#x27;</span>: path.resolve(__dirname, <span class="string">&#x27;../app&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;src&#x27;</span>: path.resolve(__dirname, <span class="string">&#x27;../src&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">      exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      use: [&#123;</span><br><span class="line">        loader: <span class="string">&#x27;awesome-typescript-loader&#x27;</span>,</span><br><span class="line">      &#125;],</span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;output&#x27;</span>, <span class="string">&#x27;main&#x27;</span>),</span><br><span class="line">    filename: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// https://webpack.js.org/configuration/node/</span></span><br><span class="line">  <span class="comment">// 避免webpack配置导致的__dirname和__filename和实际输出文件的不一致</span></span><br><span class="line">  node: &#123;</span><br><span class="line">    __dirname: <span class="literal">false</span>,</span><br><span class="line">    __filename: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 启用source-map</span></span><br><span class="line">  devtool: <span class="string">&#x27;source-map&#x27;</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里是基础的webpack配置，将应用于主进程和preload的代码编译。</p>
<p>接下来在build目录添加webpack.config.main.js作为主进程的webpack配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.config.base&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(baseConfig, &#123;</span><br><span class="line">  mode: process.env.NODE_ENV,</span><br><span class="line">  <span class="comment">// https://webpack.js.org/configuration/target/</span></span><br><span class="line">  <span class="comment">// webpack可以针对多种环境或目标进行编译，包括electron-main和electron-preload。</span></span><br><span class="line">  target: <span class="string">&#x27;electron-main&#x27;</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    index: <span class="string">&#x27;./app/index.ts&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.EnvironmentPlugin(&#123;</span><br><span class="line">      NODE_ENV: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>添加<code>tsconfig.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://www.typescriptlang.org/docs/handbook/tsconfig-json.html</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;commonjs&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;importHelpers&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es2015&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jsx&quot;</span>: <span class="string">&quot;react&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;noImplicitAny&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;allowSyntheticDefaultImports&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;paths&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;app/*&quot;</span>: [<span class="string">&quot;app/*&quot;</span>],</span><br><span class="line">      <span class="attr">&quot;src/*&quot;</span>: [<span class="string">&quot;src/*&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;include&quot;</span>: [<span class="string">&quot;app/**/*&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span>: [<span class="string">&quot;node_modules&quot;</span>, <span class="string">&quot;packages&quot;</span>, <span class="string">&quot;public&quot;</span>, <span class="string">&quot;mock&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除<code>app/index.js</code>，添加<code>app/index.ts</code>，现在我们就可以使用TypeScript来编写electron应用了。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; app, BrowserWindow &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow()</span><br><span class="line">  <span class="built_in">window</span>.loadFile(path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在package.json中添加命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;dev:main&quot;: &quot;NODE_ENV=development webpack --config ./build/webpack.config.main.js --watch&quot;</span><br></pre></td></tr></table></figure>

<p>将 <code>main</code> 字段改为输出文件的路径：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;main&quot;: &quot;output/main/index.js&quot;,</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn dev:main</span><br></pre></td></tr></table></figure>

<p>发现output目录下得到了编译后的<code>index.js</code>文件和sourcemap文件，接下来运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<p>即可启动electron app</p>
<h4 id="调试主进程"><a href="#调试主进程" class="headerlink" title="调试主进程"></a>调试主进程</h4><h5 id="使用chrome调试"><a href="#使用chrome调试" class="headerlink" title="使用chrome调试"></a>使用chrome调试</h5><p>首先可以通过electron本身提供的inspect项和chrome进行调试</p>
<p>修改package.json中的<code>start</code>命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;start&quot;: &quot;electron . --inspect-brk=5858&quot;,</span><br></pre></td></tr></table></figure>

<p>运行后打开chrome，输入 <code>chrome://inspect</code>进入inspect页面，可以看到</p>
<p><img src= "/img/loading.gif" data-lazy-src="http://mei160.cn/images//inspect_main_process_in_chrome.png"></p>
<p>点击 <code>Configure</code> 输入 <code>localhost:5858</code>，点击<code>Done</code>，即可在下面的Remote Target列表中看到我们的Electron应用，点击inspect便可以开始调试。</p>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/guides/debugging-getting-started/">文档参考</a></p>
<h5 id="使用vscode调试"><a href="#使用vscode调试" class="headerlink" title="使用vscode调试"></a>使用vscode调试</h5><p>尽管chrome的开发者工具用来调试已经相当好用，但还是抵挡不了将debugger集成到编辑器中的诱惑：在编辑器中源代码直接打断点调试实在是太方便了。</p>
<p>vscode中配置十分简单，打开debug面板，点击添加配置，launch.json配置如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Launch Program&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/app/index.ts&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;skipFiles&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;&lt;node_internals&gt;/**&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;runtimeExecutable&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/node_modules/.bin/electron&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;windows&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;runtimeExecutable&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/node_modules/.bin/electron.cmd&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;outFiles&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;$&#123;workspaceRoot&#125;/output/main/*.js&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;args&quot;</span> : [<span class="string">&quot;.&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开<code>app/index.ts</code>，在想要调试的代码左边点击打上断点，在debug面板点击<code>start debugging</code>，就会发现代码执行到断点处停住，接下来就可以自由在vscode中调试了。</p>
<p><a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/tutorial/debugging-main-process-vscode">文档参考</a></p>
<h5 id="使用webstorm调试"><a href="#使用webstorm调试" class="headerlink" title="使用webstorm调试"></a>使用webstorm调试</h5><p>和vscode类似，在webstorm中也是通过添加配置来进行调试，点击添加配置，选择Node.js，填写如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="http://mei160.cn/images/debug_main_process_in_webstorm.png"></p>
<p><a target="_blank" rel="noopener" href="https://blog.jetbrains.com/webstorm/2016/05/getting-started-with-electron-in-webstorm/">文档参考</a></p>
<h4 id="调试渲染进程"><a href="#调试渲染进程" class="headerlink" title="调试渲染进程"></a>调试渲染进程</h4><h5 id="打开控制台"><a href="#打开控制台" class="headerlink" title="打开控制台"></a>打开控制台</h5><p>修改<code>app/index.ts</code>中的代码:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow()</span><br><span class="line">  <span class="built_in">window</span>.loadFile(path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>))</span><br><span class="line">  <span class="keyword">if</span>(process.env.NODE_ENV === <span class="string">&#x27;development&#x27;</span>)&#123;</span><br><span class="line">    <span class="built_in">window</span>.webContents.openDevTools()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在开发环境下，就会自动打开chrome调试工具了</p>
<h5 id="添加preload"><a href="#添加preload" class="headerlink" title="添加preload"></a>添加preload</h5><p>在<code>app</code>文件夹下添加<code>preload.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ipcRenderer &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getAppInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> ipcRenderer.invoke(<span class="string">&#x27;app/get_basic_info&#x27;</span>) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> JSBridge = &#123;</span><br><span class="line">  getAppInfo,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.JSBridge = JSBridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> JSBridgeType = <span class="keyword">typeof</span> JSBridge;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>并在app中添加对ipc的处理：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">&#x27;will-finish-launching&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  ipcMain.handle(<span class="string">&#x27;app/get_basic_info&#x27;</span>, <span class="function"><span class="keyword">function</span> <span class="title">handleAppGetBasicInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      version: app.getVersion(),</span><br><span class="line">      name: app.name,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>由于window上没有JSBridge属性，ts会报错，此时我们在根目录添加一个global.d.ts:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; JSBridgeType &#125; <span class="keyword">from</span> <span class="string">&quot;app/preload&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="built_in">global</span>&#123;</span><br><span class="line">  <span class="keyword">interface</span> Window&#123;</span><br><span class="line">    JSBridge: JSBridgeType</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来在build下添加<code>webpack.config.preload.js</code>，将preload也输出到output目录下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">&quot;webpack-merge&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">&quot;./webpack.config.base&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(baseConfig, &#123;</span><br><span class="line">  mode: process.env.NODE_ENV,</span><br><span class="line">  target: <span class="string">&quot;electron-preload&quot;</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    preload: <span class="string">&quot;./app/preload.ts&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.EnvironmentPlugin(&#123;</span><br><span class="line">      NODE_ENV: <span class="string">&quot;development&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在package.json中添加一条preload的开发命令:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;dev:preload&quot;: &quot;NODE_ENV=development webpack --config ./build/webpack.config.preload.js --watch&quot;</span><br></pre></td></tr></table></figure>

<p>启动后就会发现output/main目录下多出一个preload.js及sourcemap</p>
<p>修改<code>app/index.ts</code>，创建BrowserWindow时注入preload.js</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PRELOAD = path.resolve(__dirname, <span class="string">&#x27;preload.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow(&#123;webPreferences: &#123;preload: PRELOAD&#125;&#125;)</span><br><span class="line">  <span class="built_in">window</span>.loadFile(path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>))</span><br><span class="line">  <span class="keyword">if</span>(process.env.NODE_ENV === <span class="string">&#x27;development&#x27;</span>)&#123;</span><br><span class="line">    <span class="built_in">window</span>.webContents.openDevTools()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在<code>app/index.html</code>中添加按钮获取app信息:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">      html,</span><br><span class="line">      body &#123;</span><br><span class="line">        background-color: antiquewhite;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleGetAppInfo</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123; version, name &#125; = <span class="keyword">await</span> <span class="built_in">window</span>.JSBridge.getAppInfo();</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(version,name)</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#version&#x27;</span>).innerText = version</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#name&#x27;</span>).innerText = name</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>version<span class="tag">&lt;/<span class="name">dt</span>&gt;</span> <span class="tag">&lt;<span class="name">dd</span> <span class="attr">id</span>=<span class="string">&quot;version&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>name<span class="tag">&lt;/<span class="name">dt</span>&gt;</span> <span class="tag">&lt;<span class="name">dd</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;handleGetAppInfo()&quot;</span>&gt;</span>get app info<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动app，点击按钮，发现能够正常获取到app信息</p>
<p>至此我们基本的开发流程就都实现了，主要包括：</p>
<ul>
<li>主进程，渲染进程，preload的编译</li>
<li>主进程和渲染进程的调试</li>
</ul>
<p>看起来是完备了，但开发时就会发现还不够用呢。接下来对这个流程做一些补充</p>
<h3 id="流程完善"><a href="#流程完善" class="headerlink" title="流程完善"></a>流程完善</h3><h4 id="启动命令完善"><a href="#启动命令完善" class="headerlink" title="启动命令完善"></a>启动命令完善</h4><p>首先安装cross-env和concurrently</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D cross-env concurrently</span><br></pre></td></tr></table></figure>
<p>修改<code>dev:main</code>和<code>dev:preload</code>命令并添加<code>dev</code>命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;dev:main&quot;: &quot;webpack --config ./build/webpack.config.main.js --watch&quot;,</span><br><span class="line">&quot;dev:preload&quot;: &quot;webpack --config ./build/webpack.config.preload.js --watch&quot;,</span><br><span class="line">&quot;dev&quot;: &quot;cross-env NODE_ENV=development concurrently \&quot;npm run dev:main\&quot; \&quot;npm run dev:preload\&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>cross-env用于兼容各平台下的<strong>环境变量设置</strong>，concurrently用于同时运行多个webpack编译的watch模式。之后app的编译只需运行<code>yarn dev</code>即可</p>
<h4 id="使用React做渲染进程开发"><a href="#使用React做渲染进程开发" class="headerlink" title="使用React做渲染进程开发"></a>使用React做渲染进程开发</h4><p>首先用<code>create-react-app</code>创建一个React应用，在项目根目录下运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn create react-app renderer</span><br></pre></td></tr></table></figure>

<p>进入renderer目录运行<code>yarn start</code>，应用默认在2333端口启动，如果报错<code>The react-scripts package provided by Create React App requires a dependency: webpack</code>，可以在renderer目录下添加.env文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SKIP_PREFLIGHT_CHECK&#x3D;true</span><br></pre></td></tr></table></figure>

<p>这时候我们将<code>app/index.ts</code>中的<code>window.loadFile ...</code>改为</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.loadURL(<span class="string">&#x27;http://localhost:2333&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>重启Electron应用即可看到渲染的窗口加载了本地的React应用</p>
<p>但是这里会有一个问题，在打包时我们会将渲染进程的代码打包进去，窗口加载实际上是通过loadFile的方式进行的，如果本地开发的时候使用本地http地址开发，实际效果和打包出来的效果是会有出入的，因此我们再做一些修改，将开发时生成的文件输出到<code>output/renderer</code>目录下，然后通过loadFile的方式加载它。</p>
<p>那么我们就需要修改cra项目的webpack中对应的output配置和path中的appBuild配置来改变输出目录，然后修改devServer的配置让开发时也输出文件，并且修改socket配置保证热更新能正常使用。</p>
<p>因为cra项目本身没有将配置暴露出来，这里我们做的改动不多，因此选择使用<code>react-app-rewired</code>而非eject弹出配置。</p>
<p>首先安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D react-app-rewired react-dev-utils</span><br></pre></td></tr></table></figure>

<p>然后在renderer目录下新建<code>config-overrides.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> OUTPUT_PATH = path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;output&#x27;</span>, <span class="string">&#x27;renderer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    webpack: <span class="function"><span class="keyword">function</span>(<span class="params">config, env</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 修改输出目录</span></span><br><span class="line">        config.output.path = OUTPUT_PATH</span><br><span class="line">        <span class="comment">// 修改publicPath，否则静态资源文件会引用失败</span></span><br><span class="line">        config.output.publicPath = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;,</span><br><span class="line">    devServer: <span class="function"><span class="keyword">function</span>(<span class="params">configFunction</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">proxy, allowedHost</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">const</span> config = configFunction(proxy, allowedHost);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将文件输出到硬盘</span></span><br><span class="line">            config.writeToDisk = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 修改sock相关配置保证热更新功能正常</span></span><br><span class="line">            config.host = process.env.HOST || <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line">            config.sockHost = process.env.WDS_SOCKET_HOST;</span><br><span class="line">            config.sockPath = process.env.WDS_SOCKET_PATH; <span class="comment">// default: &#x27;/sockjs-node&#x27;</span></span><br><span class="line">            config.sockPort = process.env.WDS_SOCKET_PORT;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    paths: <span class="function"><span class="keyword">function</span>(<span class="params">paths, env</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 修改build下的输出目录</span></span><br><span class="line">        paths.appBuild = OUTPUT_PATH</span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新启动react项目，发现<code>output/renderer</code>目录下输出了对应的静态文件</p>
<p>然后我们将<code>app/index.ts</code>中的<code>window.loadURL ...</code>注释，添加一行</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// window.loadURL(&#x27;http://localhost:2333&#x27;)</span></span><br><span class="line"><span class="built_in">window</span>.loadFile(path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;output&#x27;</span>, <span class="string">&#x27;renderer&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>重新启动应用，发现加载成功。</p>
<h4 id="给devtools添加plugins"><a href="#给devtools添加plugins" class="headerlink" title="给devtools添加plugins"></a>给devtools添加plugins</h4><p>渲染进程使用了react进行开发，为了更方便的调试，我们来给devtools安装浏览器插件。</p>
<p>首先找到chrome插件的位置</p>
<ul>
<li><p>windows</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%LOCALAPPDATA%\Google\Chrome\User Data\Default\Extensions</span><br></pre></td></tr></table></figure></li>
<li><p>MacOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;Library&#x2F;Application Support&#x2F;Google&#x2F;Chrome&#x2F;Default&#x2F;Extensions</span><br></pre></td></tr></table></figure>
</li>
<li><p>Linux，有几个可能的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;.config&#x2F;google-chrome&#x2F;Default&#x2F;Extensions&#x2F;</span><br><span class="line">~&#x2F;.config&#x2F;google-chrome-beta&#x2F;Default&#x2F;Extensions&#x2F;</span><br><span class="line">~&#x2F;.config&#x2F;google-chrome-canary&#x2F;Default&#x2F;Extensions&#x2F;</span><br><span class="line">~&#x2F;.config&#x2F;chromium&#x2F;Default&#x2F;Extensions&#x2F;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>打开目录会发现下面都是根据以扩展id命名的文件夹，想要找到扩展对应的id，可以在chrome中打开<code>chrome://extensions/</code>，点击对应扩展的详细信息，即可从url参数上找到id。</p>
<p>以<code>React Developer Tools</code>在MacOS上的为例，在<code>app/index.ts</code>中添加：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EXTENSION_PATH_REACT_DEV_TOOLS = path.join(<span class="string">&#x27;/Users/wangshuwen/Library/Application Support/Google/Chrome/Default/Extensions/&#x27;</span>, <span class="string">&#x27;fmkadmapgofadopljbjfkapdkoienihi&#x27;</span>, <span class="string">&#x27;4.8.2_0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> e = <span class="keyword">await</span> session.defaultSession.loadExtension(EXTENSION_PATH_REACT_DEV_TOOLS)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow(&#123;webPreferences: &#123;preload: PRELOAD&#125;&#125;)</span><br><span class="line">  <span class="built_in">window</span>.loadURL(<span class="string">&#x27;http://localhost:2333&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>由于Electron本身原因，通过<code>session.loadExtension</code>添加的插件目前React Dev Tools在file协议下无法访问文件，需要在http协议下进行调试。</p>
<p>备选方案：改为使用<code>BrowserWindow.addDevToolsExtension</code>方法添加插件，在Electron 9.0.0版本以下生效</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  BrowserWindow.addDevToolsExtension(EXTENSION_PATH_REACT_DEV_TOOLS)</span><br><span class="line">  <span class="comment">// const e = await session.defaultSession.loadExtension(EXTENSION_PATH_REACT_DEV_TOOLS)</span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>但是注意这个方法即将被Electron废弃，待Electron修复<code>session.loadExtension</code>的问题后可以更换掉此方法。</p>
<p>如果觉得手动找插件添加的方式过于麻烦，也可以使用<a target="_blank" rel="noopener" href="https://github.com/MarshallOfSound/electron-devtools-installer">electron-devtools-installer</a>这个库来进行扩展管理。</p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/tutorial/devtools-extension">devtools-extension</a></li>
<li><a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/api/session#sesloadextensionpath">session#load-extension</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/electron/electron/issues/24011">Extensions don’t work with file:// protocol since 9.0.0</a></li>
</ul>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>Electron常用的打包工具有这么几个：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/electron/electron-packager">electron-packager</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/electron-userland/electron-forge">electron-forge</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/electron-userland/electron-builder">electron-builder</a></li>
</ul>
<p><code>electron-packager</code>和<code>electron-builder</code>是单纯的Electron打包工具，<code>electron-forge</code>类似于一个CLI工具，参与从创建项目到开发和打包的流程。</p>
<p><code>electron-packager</code>较为轻量，上手使用迅速，适合简单的项目打包。相对而言<code>electron-builder</code>配置更加复杂和全面一些，这里我们选择<code>electron-builder</code>作为打包工具。</p>
<h3 id="基本打包配置"><a href="#基本打包配置" class="headerlink" title="基本打包配置"></a>基本打包配置</h3><p>首先我们需要将主进程、preload、渲染进程的代码编译输出到output目录，假定output目录下文件结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── main</span><br><span class="line">│   ├── index.js                &#x2F;&#x2F; 主进程入口文件</span><br><span class="line">│   ├── index.js.map</span><br><span class="line">│   ├── preload.js              &#x2F;&#x2F; preload文件</span><br><span class="line">│   └── preload.js.map</span><br><span class="line">└── renderer                    &#x2F;&#x2F; 渲染进程的静态文件</span><br><span class="line">    ├── static </span><br><span class="line">    ├── favicon.ico</span><br><span class="line">    ├── index.html</span><br><span class="line">    ├── manifest.json</span><br><span class="line">    ├── precache-manifest.4afa4365236dd3705833cb35553e2f08.js</span><br><span class="line">    ├── robots.txt</span><br><span class="line">    ├── service-worker.js</span><br><span class="line">    └── asset-manifest.json</span><br></pre></td></tr></table></figure>

<h4 id="添加build命令"><a href="#添加build命令" class="headerlink" title="添加build命令"></a>添加build命令</h4><p>在<code>package.json</code>中添加build命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;build:main&quot;: &quot;webpack --config ./build/webpack.config.main.js&quot;,</span><br><span class="line">&quot;build:preload&quot;: &quot;webpack --config ./build/webpack.config.preload.js&quot;,</span><br><span class="line">&quot;build:renderer&quot;: &quot;cd ./renderer &amp;&amp; npm run build&quot;,</span><br><span class="line">&quot;build&quot;: &quot;cross-env NODE_ENV=production concurrently \&quot;npm run build:main\&quot; \&quot;npm run build:preload\&quot; \&quot;npm run build:renderer\&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>启动 <code>npm run build</code>，可以发现output目录下生成了对应的文件目录。</p>
<h4 id="安装electron-builder"><a href="#安装electron-builder" class="headerlink" title="安装electron-builder"></a>安装electron-builder</h4><p>安装必需的依赖项</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add electron-builder -D</span><br></pre></td></tr></table></figure>

<p>package.json中添加”postinstall”命令，在安装依赖项后可以自动安装electron-builder的依赖项</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;postinstall&quot;: &quot;electron-builder install-app-deps&quot;</span><br></pre></td></tr></table></figure>

<h4 id="添加配置文件"><a href="#添加配置文件" class="headerlink" title="添加配置文件"></a>添加配置文件</h4><p>在项目根目录添加<code>electron-builder.yml</code>，electron-builder会默认读取该文件作为配置文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">appId:</span> <span class="string">&#x27;com.my-app&#x27;</span></span><br><span class="line"><span class="attr">productName:</span> <span class="string">&#x27;My App&#x27;</span></span><br><span class="line"><span class="attr">copyright:</span> <span class="string">Copyright</span> <span class="string">©</span> <span class="number">2020</span> <span class="string">$&#123;author&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">directories:</span></span><br><span class="line">  <span class="attr">buildResources:</span> <span class="string">resources</span></span><br><span class="line">  <span class="attr">output:</span> <span class="string">release/$&#123;version&#125;</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">buildVersion:</span> <span class="number">1.0</span><span class="number">.0</span> </span><br><span class="line"><span class="attr">artifactName:</span> <span class="string">$&#123;productName&#125;-$&#123;version&#125;-$&#123;channel&#125;.$&#123;ext&#125;</span></span><br><span class="line"><span class="attr">files:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">output</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resources</span></span><br><span class="line"><span class="attr">asar:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">publish:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">provider:</span> <span class="string">generic</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://update.electron-builder.com</span></span><br><span class="line">    <span class="attr">channel:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">releaseInfo:</span></span><br><span class="line">  <span class="attr">releaseName:</span> <span class="string">&#x27;A New Playground for Electron!&#x27;</span></span><br><span class="line">  <span class="attr">releaseNotes:</span> <span class="string">&#x27;Some new features now is available.&#x27;</span></span><br></pre></td></tr></table></figure>

<p>简单分析一下上面的配置文件：</p>
<ul>
<li><strong>appId</strong>: 应用id，不同平台有不同的规则<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html#//apple_ref/doc/uid/20001431-102070">MacOS</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lcid/a9eac961-e77d-41a6-90a5-ce1a8b0cdb9c?redirectedfrom=MSDN">Windows</a></li>
</ul>
</li>
<li><strong>directories</strong><ul>
<li>buildResources: 构建资源文件目录，不会打包到app中，如果需要打包其中的一些文件比如托盘图标，需要在files字段中指定，比如 <code>&quot;files&quot;: [&quot;**/*&quot;, &quot;build/icon.*&quot;]</code></li>
<li>output: 打包输出目录</li>
<li>app: 包含package.json的应用目录，默认会读取 <code>app</code>, <code>www</code>, 或当前工作目录，通常不用指定 </li>
</ul>
</li>
<li><strong>files</strong>: 指定需要复制过去打包的文件，<a target="_blank" rel="noopener" href="https://www.electron.build/configuration/contents#files">参考文档</a></li>
<li><strong>asar</strong>: 是否打包成asar档案文件, <a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/tutorial/application-packaging">参考文档</a></li>
<li><strong>publish</strong>: 发布选项，和更新服务器类型相关， <a target="_blank" rel="noopener" href="https://www.electron.build/configuration/publish">参考文档</a></li>
</ul>
<h4 id="1-4-添加打包命令"><a href="#1-4-添加打包命令" class="headerlink" title="1.4 添加打包命令"></a>1.4 添加打包命令</h4><p>在package.json中添加打包命令:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;pack-mac&quot;: &quot;electron-builder build --mac&quot;,</span><br><span class="line">&quot;pack-win&quot;: &quot;electron-builder build --win&quot;,</span><br><span class="line">&quot;pack-all&quot;: &quot;electron-builder build -mw&quot;,</span><br></pre></td></tr></table></figure>

<p>接下来开始打包，首先运行<code>yarn run build</code>，编译文件到output目录，接下来运行<code>yarn pack-all</code>，开始打包Windows和MacOS的应用。</p>
<p>运行结束后可以发现在release目录下出现了对应的版本文件夹，里面有打包好的安装文件和更新入口文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── 1.0.0</span><br><span class="line">    ├── My App-1.0.0-latest.dmg</span><br><span class="line">    ├── My App-1.0.0-latest.dmg.blockmap</span><br><span class="line">    ├── My App-1.0.0-latest.exe</span><br><span class="line">    ├── My App-1.0.0-latest.exe.blockmap</span><br><span class="line">    ├── My App-1.0.0-latest.zip</span><br><span class="line">    ├── builder-effective-config.yaml</span><br><span class="line">    ├── latest-mac.yml</span><br><span class="line">    ├── latest.yml</span><br><span class="line">    ├── mac</span><br><span class="line">    └── win-unpacked</span><br></pre></td></tr></table></figure>

<h3 id="代码签名"><a href="#代码签名" class="headerlink" title="代码签名"></a>代码签名</h3><p>electron-builder支持MacOS和Windows的签名</p>
<p>但是由于MacOS应用的代码签名必须在MacOS机器上完成，而且MacOS可以进行Windows应用签名，因此建议使用MacOS机器进行打包签名。</p>
<h4 id="MacOS代码签名"><a href="#MacOS代码签名" class="headerlink" title="MacOS代码签名"></a>MacOS代码签名</h4><p>electron在进行代码签名的时候会自动检查环境变量中的对应字段，包括：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong>CSC_LINK</strong></td>
<td>.p12或.pfx证书文件的HTTPS链接（或base64编码数据，或file链接，或本地路径）。</td>
</tr>
<tr>
<td><strong>CSC_KEY_PASSWORD</strong></td>
<td>证书密码</td>
</tr>
<tr>
<td><strong>CSC_NAME</strong></td>
<td>(MacOS) login.keychain中的证书名称</td>
</tr>
<tr>
<td><strong>CSC_IDENTITY_AUTO_DISCOVERY</strong></td>
<td>(MacOS) MacOS上是否自动使用keychain中的身份</td>
</tr>
<tr>
<td><strong>CSC_KEYCHAIN</strong></td>
<td>(MacOS) keychain名称。如果未指定CSC_LINK则使用。默认为系统默认keychain。</td>
</tr>
<tr>
<td><strong>WIN_CSC_LINK</strong></td>
<td>(Windows) 类似<code>CSC_LINK</code>，在MacOS上签名Windows应用时使用</td>
</tr>
<tr>
<td><strong>WIN_CSC_KEY_PASSWORD</strong></td>
<td>(Windows) 类似<code>CSC_KEY_PASSWORD</code>，在MacOS上签名Windows应用时使用</td>
</tr>
</tbody></table>
<p>在MacOS上签名就可以有几种选择：</p>
<ol>
<li><p>安装对应的证书到keychain，然后<code>CSC_NAME</code>指定为证书在keychain中显示的名称，<code>CSC_KEY_PASSWORD</code>设置为证书密码，打包时就会自动进行签名。</p>
</li>
<li><p>将证书文件放在对应目录，<code>CSC_LINK</code>设置为对应的路径，<code>CSC_KEY_PASSWORD</code>设置为证书密码即可。若担心证书和密码都放在项目中不合适，可以去掉项目中的证书密码，修改打包脚本，每次运行打包命令时输入密码并设置到环境变量。</p>
</li>
</ol>
<h4 id="Windows代码签名"><a href="#Windows代码签名" class="headerlink" title="Windows代码签名"></a>Windows代码签名</h4><ol>
<li>在Windows机器上签名，同样的指定<code>CSC_LINK</code>和<code>CSC_KEY_PASSWORD</code>即可</li>
<li>在Mac机器上签名，需要将<code>CSC_LINK</code>和<code>CSC_KEY_PASSWORD</code>替换为<code>WIN_CSC_LINK</code>和<code>WIN_CSC_KEY_PASSWORD</code></li>
</ol>
<p>如果需要申请Windows代码签名证书，可以参考这篇<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/dashboard/get-a-code-signing-certificate">文档</a></p>
<h3 id="更详细的平台target配置"><a href="#更详细的平台target配置" class="headerlink" title="更详细的平台target配置"></a>更详细的平台target配置</h3><p>electron-builder支持多种类型的安装文件打包</p>
<ul>
<li>Mac平台支持.dmg和.pkg，</li>
<li>Windows平台支持nsis, nsisWeb, appx, squirrelWindows</li>
</ul>
<h4 id="MacOS配置"><a href="#MacOS配置" class="headerlink" title="MacOS配置"></a>MacOS配置</h4><p>以MacOS下打包.dmg文件为例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">mac:</span></span><br><span class="line">  <span class="attr">target:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dmg</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">resources/icon.icns</span></span><br><span class="line">  <span class="attr">category:</span> <span class="string">public.app-category.developer-tools</span></span><br><span class="line">  <span class="attr">hardenedRuntime:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">entitlements:</span> <span class="string">resources/entitlements.mac.plist</span></span><br><span class="line">  <span class="attr">extendInfo:</span> </span><br><span class="line">    <span class="attr">NSMicrophoneUsageDescription:</span> <span class="string">请允许访问您的麦克风</span></span><br><span class="line">    <span class="attr">NSCameraUsageDescription:</span> <span class="string">请允许访问您的摄像头</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dmg:</span></span><br><span class="line">  <span class="attr">background:</span> <span class="string">resources/background.png</span></span><br><span class="line">  <span class="attr">iconSize:</span> <span class="number">128</span></span><br><span class="line">  <span class="attr">iconTextSize:</span> <span class="number">13</span></span><br><span class="line">  <span class="attr">window:</span></span><br><span class="line">    <span class="attr">width:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">height:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>category</strong> 应用在Mac下的分类，分类<a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/LaunchServicesKeys.html#//apple_ref/doc/uid/TP40009250-SW8">参考文档</a></li>
<li><strong>hardenedRuntime</strong> 应用是否使用hardenedRuntime进行签名。hardenedRuntime用于管理macOS应用程序的安全保护和资源访问。相关的<a href="">参考文档</a></li>
<li><strong>entitlements</strong> 对应的entitlements.mac.plist文件，该文件用于获取授权的定义。<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/bundleresources/entitlements">参考文档</a></li>
<li><strong>extendInfo</strong> Info.plist的额外条目，主要用于配置一些应用属性。<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/bundleresources/information_property_list">参考文档</a></li>
</ul>
<p>比如下面这个entitlements.mac.plist</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">plist</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="meta-string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>com.apple.security.device.audio-input<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>com.apple.security.device.camera<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>声明了对录音和摄像头权限的申请</p>
<h4 id="Windows配置"><a href="#Windows配置" class="headerlink" title="Windows配置"></a>Windows配置</h4><p>以打包nsis文件为例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">win:</span></span><br><span class="line">  <span class="attr">target:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="string">nsis</span></span><br><span class="line">      <span class="attr">arch:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">x64</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ia32</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">resources/icon.ico</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nsis:</span></span><br><span class="line">  <span class="attr">oneClick:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">perMachine:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">allowToChangeInstallationDirectory:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">resources/eula.txt</span></span><br><span class="line">  <span class="attr">deleteAppDataOnUninstall:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">displayLanguageSelector:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>oneClick</strong> 是否创建一个<code>oneClick</code>安装程序，和通常的windows安装程序不一样，<code>oneClick</code>安装程序点击后会直接安装，不需要一步一步选择选项然后点击确定，但在用户体验来说可能用户觉得不能选择安装目录，用户等选项有些流氓，而且看不到安装进度不知道什么时候安装成功。</li>
<li><strong>perMachine</strong> 是否显示安装模式，即选择安装给所有用户或者安装给当前用户</li>
<li><strong>allowToChangeInstallationDirectory</strong> 允许改变安装目录</li>
<li><strong>license</strong> 最终用户许可协议，支持.txt, .rtf, .html</li>
<li><strong>deleteAppDataOnUninstall</strong> 卸载时清除数据</li>
<li><strong>displayLanguageSelector</strong> 是否显示语言选择器，选否则根据系统语言自动判断</li>
</ul>
<h3 id="多平台的插件打包"><a href="#多平台的插件打包" class="headerlink" title="多平台的插件打包"></a>多平台的插件打包</h3><h4 id="找到插件执行文件"><a href="#找到插件执行文件" class="headerlink" title="找到插件执行文件"></a>找到插件执行文件</h4><p>在MacOS下通常是*.plugin文件，Windows下为*.dll文件，这里以32.0.0.414版本的flash player为例子，到adobe flash官网下载并安装flash player后，其目录通常在</p>
<ul>
<li>MacOS： /Library/Internet Plug-Ins/PepperFlashPlayer/PepperFlashPlayer.plugin</li>
<li>Windows: C:\Windows\SysWOW64\Macromed\Flash\pepflashplayer32_0_0_414.dll 或 C:\Windows\System32\Macromed\Flash\pepflashplayer64_32_0_0_414.dll</li>
</ul>
<h4 id="添加编译配置"><a href="#添加编译配置" class="headerlink" title="添加编译配置"></a>添加编译配置</h4><p>将找到的插件复制到项目的plugins目录下，根据平台区分目录，假设目录如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins</span><br><span class="line">├── darwin</span><br><span class="line">│   └── PepperFlashPlayer.plugin</span><br><span class="line">└── win32</span><br><span class="line">    └── pepflashplayer.dll</span><br></pre></td></tr></table></figure>

<p>接下来在webpack配置中添加配置，启动编译时可以将plugins下对应平台的文件自动复制到output下的plugins目录</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CopyPlugin = <span class="built_in">require</span>(<span class="string">&#x27;copy-webpack-plugin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据平台判断插件目录</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPluginSourceDir</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.platform === <span class="string">&quot;darwin&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;plugins&quot;</span>, <span class="string">&quot;darwin&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.platform === <span class="string">&quot;win32&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;plugins&quot;</span>, <span class="string">&quot;win32&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`can not find plugins directory for platform <span class="subst">$&#123;process.platform&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CopyPlugin(&#123;</span><br><span class="line">      patterns: [</span><br><span class="line">        &#123; </span><br><span class="line">          <span class="keyword">from</span>: getPluginSourceDir(),</span><br><span class="line">          to: path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;output&#x27;</span>, <span class="string">&#x27;plugins&#x27;</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="加载插件"><a href="#加载插件" class="headerlink" title="加载插件"></a>加载插件</h4><p>加载插件需要在app中通过调用对应的api，并且在创建BrowserWindow时将webPreferences选项中的plugins设置为true</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pluginName</span><br><span class="line"><span class="keyword">switch</span> (process.platform) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">    pluginName = <span class="string">&#x27;pepflashplayer.dll&#x27;</span></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;darwin&#x27;</span>:</span><br><span class="line">    pluginName = <span class="string">&#x27;PepperFlashPlayer.plugin&#x27;</span></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">app.commandLine.appendSwitch(<span class="string">&#x27;ppapi-flash-path&#x27;</span>, path.join(__dirname, <span class="string">&#x27;..&#x27;</span>,<span class="string">&#x27;plugins&#x27;</span>, pluginName <span class="keyword">as</span> <span class="built_in">string</span>))</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow(&#123;webPreferences: &#123;preload: PRELOAD, plugins: <span class="literal">true</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>加载一个包含flash的url</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.loadURL(EXAMPLE_FLASH_URL)</span><br></pre></td></tr></table></figure>
<p>重新启动应用，发现flash可以正常运行了</p>
<h4 id="加载系统安装的-Pepper-Flash-插件"><a href="#加载系统安装的-Pepper-Flash-插件" class="headerlink" title="加载系统安装的 Pepper Flash 插件"></a>加载系统安装的 Pepper Flash 插件</h4><p>这种方式只适用于flash插件，上面的根据平台获取插件，加载指定目录等操作都不需要了，而是直接加载系统已经安装的flash插件，这也意味着如果系统没有安装flash插件就无法使用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.commandLine.appendSwitch(<span class="string">&#x27;ppapi-flash-path&#x27;</span>, app.getPath(<span class="string">&#x27;pepperFlashSystemPlugin&#x27;</span>))</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow(&#123;webPreferences: &#123;preload: PRELOAD, plugins: <span class="literal">true</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="创建多平台多环境打包的命令行工具"><a href="#创建多平台多环境打包的命令行工具" class="headerlink" title="创建多平台多环境打包的命令行工具"></a>创建多平台多环境打包的命令行工具</h3><p>在实际业务中，打包往往不是单纯的<code>electron-builder build</code>就可以实现，可能会有许多类似区分环境和平台，定制打包产出，打包后上传等需求，在这种时候可能就需要做一些更复杂的工作了。</p>
<p>比如在一个常见的业务场景，需要实现以下功能：</p>
<ol>
<li>版本更新;</li>
<li>同步更新信息到CHANGELOG;</li>
<li>区分环境打包;</li>
<li>区分平台打包;</li>
<li>打包后自动上传;</li>
</ol>
<p>针对这些功能做一个流程设计：</p>
<ol>
<li>输入版本号(不输入则自动patch)后，校验版本号是否正确，更新package.json</li>
<li>输入更新的信息和更新的描述，并同步写入到CHANGELOG</li>
<li>读取用户选择的环境，可以多选，并在后续的打包流程中针对不同环境实现不同的操作(环境变量注入等);</li>
<li>读取用户选择的平台，可以多选，在后续打包中只打包对应的平台;</li>
<li>打包结束后自动上传到服务器(以ftp为例);</li>
</ol>
<p>接下来根据功能流程设计来划分功能模块：</p>
<ol>
<li>Inquirer: 读取用户输入项并提供校验;</li>
<li>CommandExecutor: 执行命令行命令的函数;</li>
<li>JsonUpdater: 提供读写操作更新package.json和package-lock.json;</li>
<li>ChangelogUpdater: 更新CHANGELOG</li>
<li>Builder: 使用electron-builder进行打包操作</li>
<li>FileUploader: 通过ftp进行文件上传</li>
</ol>
<p>接下来实现这些功能模块：</p>
<p><code>build/packaging-cli/inquirer.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> inquirer <span class="keyword">from</span> <span class="string">&quot;inquirer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> envs = [<span class="string">&quot;test&quot;</span>, <span class="string">&quot;prod&quot;</span>] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br><span class="line"><span class="keyword">const</span> platforms = [<span class="string">&quot;win&quot;</span>, <span class="string">&quot;mac&quot;</span>] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> envType = <span class="keyword">typeof</span> envs[<span class="built_in">number</span>]</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> platformType = <span class="keyword">typeof</span> platforms[<span class="built_in">number</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = [</span><br><span class="line">  &#123; <span class="keyword">type</span>: <span class="string">&quot;input&quot;</span>, name: <span class="string">&quot;version&quot;</span>, message: <span class="string">`版本号？`</span> &#125;,</span><br><span class="line">  &#123; <span class="keyword">type</span>: <span class="string">&quot;input&quot;</span>, name: <span class="string">&quot;releaseName&quot;</span>, message: <span class="string">`更新标题`</span>, <span class="keyword">default</span>: <span class="string">&quot;更新&quot;</span> &#125;,</span><br><span class="line">  &#123; <span class="keyword">type</span>: <span class="string">&quot;editor&quot;</span>, name: <span class="string">&quot;releaseNotes&quot;</span>, message: <span class="string">`更新描述:`</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">&quot;list&quot;</span>,</span><br><span class="line">    name: <span class="string">&quot;env&quot;</span>,</span><br><span class="line">    message: <span class="string">&quot;环境？&quot;</span>,</span><br><span class="line">    choices: envs.map(<span class="function">(<span class="params">e</span>) =&gt;</span> (&#123; name: e, value: e &#125;)),</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">&quot;list&quot;</span>,</span><br><span class="line">    name: <span class="string">&quot;platforms&quot;</span>,</span><br><span class="line">    message: <span class="string">&quot;平台？&quot;</span>,</span><br><span class="line">    choices: [</span><br><span class="line">      &#123; name: <span class="string">&quot;all&quot;</span>, value: platforms &#125;,</span><br><span class="line">      ...platforms.map(<span class="function">(<span class="params">p</span>) =&gt;</span> (&#123; name: p, value: [p] &#125;)),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> QueryResult &#123;</span><br><span class="line">  env: envType;</span><br><span class="line">  platforms: platformType[];</span><br><span class="line">  version: <span class="built_in">string</span>;</span><br><span class="line">  releaseName: <span class="built_in">string</span>;</span><br><span class="line">  releaseNotes: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> inquirer.prompt&lt;QueryResult&gt;(options);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>build/packaging-cli/command-executor.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; spawn &#125; <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">execCommand</span>(<span class="params">command: <span class="built_in">string</span>, args: <span class="built_in">string</span>[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ls = spawn(command, args, &#123; stdio: <span class="string">&#x27;inherit&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    ls.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(error.message)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ls.on(<span class="string">&#x27;close&#x27;</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`[<span class="subst">$&#123;command&#125;</span> <span class="subst">$&#123;args.join(<span class="string">&#x27; &#x27;</span>)&#125;</span>]`</span> + <span class="string">`exited with code <span class="subst">$&#123;code&#125;</span>`</span>)</span><br><span class="line">      code === <span class="number">0</span> ? resolve() : reject(code)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>build/packaging-cli/json-updater.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readJsonSync, writeJSONSync &#125; <span class="keyword">from</span> <span class="string">&quot;fs-extra&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PACKAGE_JSON_PATH = path.resolve(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;package.json&quot;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PACKAGE_JSON_LOCK_PATH = path.resolve(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;package-lock.json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取json内容</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> readJSON = <span class="function">(<span class="params">path: <span class="built_in">string</span></span>) =&gt;</span> () =&gt; readJsonSync(path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 覆写json变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> writeJSON = <span class="function">(<span class="params">path: <span class="built_in">string</span></span>) =&gt;</span> (vars: <span class="built_in">any</span>) =&gt; writeJSONSync(path, vars);</span><br></pre></td></tr></table></figure>

<p><code>build/packaging-cli/changelog-updater.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="keyword">import</span> dayjs <span class="keyword">from</span> <span class="string">&#x27;dayjs&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> ChangeLog &#123;</span><br><span class="line">  version: <span class="built_in">string</span></span><br><span class="line">  releaseName: <span class="built_in">string</span></span><br><span class="line">  releaseNotes: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CHANGE_LOG_PATH = path.resolve(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;CHANGELOG.md&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateChangeLog</span>(<span class="params">cl: ChangeLog</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; version, releaseName, releaseNotes &#125; = cl</span><br><span class="line">  <span class="keyword">const</span> content = <span class="string">`## 版本：<span class="subst">$&#123;version&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- <span class="subst">$&#123;dayjs().format(<span class="string">&#x27;YYYY-MM-DD hh:mm:ss&#x27;</span>)&#125;</span></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"><span class="subst">$&#123;releaseName&#125;</span></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">\`\`\` </span></span><br><span class="line"><span class="string"><span class="subst">$&#123;releaseNotes&#125;</span></span></span><br><span class="line"><span class="string">\`\`\`</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line">  fs.appendFileSync(CHANGE_LOG_PATH, content)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>build/packaging-cli/builder.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; envType, platformType &#125; <span class="keyword">from</span> <span class="string">&quot;./inquirer&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; execCommand &#125; <span class="keyword">from</span> <span class="string">&quot;./command-executor&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params">env: envType, platforms: platformType[]</span>) </span>&#123;</span><br><span class="line">  process.env.ENV = env;</span><br><span class="line">  <span class="keyword">await</span> execCommand(<span class="string">`npm`</span>, [<span class="string">&quot;run&quot;</span>, <span class="string">&quot;build&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> buildArgs = [<span class="string">&quot;build&quot;</span>];</span><br><span class="line">  <span class="keyword">if</span> (platforms.includes(<span class="string">&quot;win&quot;</span>)) buildArgs.push(<span class="string">&quot;--win&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (platforms.includes(<span class="string">&quot;mac&quot;</span>)) buildArgs.push(<span class="string">&quot;--mac&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> execCommand(<span class="string">`electron-builder`</span>, buildArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FTPClient <span class="keyword">from</span> <span class="string">&quot;ftp&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientConfig = &#123;</span><br><span class="line">  host: <span class="string">&quot;host.to.your.server&quot;</span>,</span><br><span class="line">  port: <span class="number">60021</span>,</span><br><span class="line">  user: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">  password: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Client = <span class="keyword">new</span> FTPClient();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectClient</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    Client.on(<span class="string">&quot;ready&quot;</span>, resolve);</span><br><span class="line">    Client.on(<span class="string">&quot;error&quot;</span>, reject);</span><br><span class="line">    Client.connect(clientConfig);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">putFile</span>(<span class="params">file: <span class="built_in">string</span>, dest: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    Client.put(file, dest, <span class="function">(<span class="params">err</span>) =&gt;</span> (err ? reject(err) : resolve()));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadDir</span>(<span class="params">dir: <span class="built_in">string</span>, dest: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> connectClient();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> task: [<span class="built_in">string</span>, <span class="built_in">string</span>][] = fs</span><br><span class="line">    .readdirSync(dir)</span><br><span class="line">    .map(<span class="function">(<span class="params">f</span>) =&gt;</span> path.resolve(dir, f))</span><br><span class="line">    .filter(<span class="function">(<span class="params">f</span>) =&gt;</span> fs.statSync(f).isFile())</span><br><span class="line">    .map(<span class="function">(<span class="params">f</span>) =&gt;</span> ([f, <span class="string">`<span class="subst">$&#123;dest&#125;</span>/<span class="subst">$&#123;path.basename(f)&#125;</span>`</span>]));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.all(task.map(<span class="function">(<span class="params">[src, dest]</span>) =&gt;</span> putFile(src, dest)));</span><br><span class="line"></span><br><span class="line">  Client.end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后是packaging-cli脚本的入口文件，统领整个打包流程;</p>
<p><code>build/packaging-cli/index.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; query &#125; <span class="keyword">from</span> <span class="string">&quot;./inquirer&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readJSON, PACKAGE_JSON_PATH &#125; <span class="keyword">from</span> <span class="string">&quot;./json-updater&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; execCommand &#125; <span class="keyword">from</span> <span class="string">&quot;./command-executor&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; updateChangeLog &#125; <span class="keyword">from</span> <span class="string">&quot;./changelog-updater&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; build &#125; <span class="keyword">from</span> <span class="string">&quot;./builder&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; uploadDir &#125; <span class="keyword">from</span> <span class="string">&quot;./file-uploader&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RELEASE_DIR = path.resolve(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;release&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">startPackaging</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; version, env, platforms, releaseName, releaseNotes &#125; = <span class="keyword">await</span> query();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新版本号</span></span><br><span class="line">  <span class="keyword">await</span> execCommand(<span class="string">&quot;npm&quot;</span>, [<span class="string">&quot;version&quot;</span>, version ? version : <span class="string">&quot;patch&quot;</span>]);</span><br><span class="line">  version = readJSON(PACKAGE_JSON_PATH)().version;</span><br><span class="line">  <span class="comment">// 更新CHANGELOG</span></span><br><span class="line">  updateChangeLog(&#123; version, releaseName, releaseNotes &#125;);</span><br><span class="line">  <span class="comment">// 开始打包</span></span><br><span class="line">  <span class="keyword">await</span> build(env, platforms);</span><br><span class="line">  <span class="comment">// 上传文件</span></span><br><span class="line">  <span class="keyword">await</span> uploadDir(path.resolve(RELEASE_DIR, version), <span class="string">&quot;test-app-temp&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startPackaging();</span><br></pre></td></tr></table></figure>

<p>在package.json中添加命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;pack&quot;: &quot;ts-node ./build/packaging-cli/index.ts&quot;,</span><br></pre></td></tr></table></figure>

<p>运行<code>yarn run pack</code>即可开始打包</p>
<h2 id="自动更新"><a href="#自动更新" class="headerlink" title="自动更新"></a>自动更新</h2><p>前面打包流程基于Electron-Builder，因此以下的更新讨论也是基于其提供的<a href="">electron-updater</a>。</p>
<h3 id="关于electron-updater"><a href="#关于electron-updater" class="headerlink" title="关于electron-updater"></a>关于electron-updater</h3><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><p>electron-updater只适用于以下类型的应用包：</p>
<ul>
<li>MacOS: DMG</li>
<li>Windows: NSIS</li>
<li>Linux: AppImage</li>
</ul>
<h4 id="提供的API"><a href="#提供的API" class="headerlink" title="提供的API"></a>提供的API</h4><p><a target="_blank" rel="noopener" href="https://www.electron.build/auto-update#api">文档</a></p>
<table>
<thead>
<tr>
<th>API方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>checkForUpdates()</code></td>
<td>检查更新</td>
</tr>
<tr>
<td><code>checkForUpdatesAndNotify()</code></td>
<td>检查更新，有更新则提示</td>
</tr>
<tr>
<td><code>downloadUpdate(cancellationToken)</code></td>
<td>下载更新</td>
</tr>
<tr>
<td><code>getFeedURL()</code></td>
<td>获取更新服务链接</td>
</tr>
<tr>
<td><code>setFeedURL(options)</code></td>
<td>设置更新服务链接</td>
</tr>
<tr>
<td><code>quitAndInstall(isSilent, isForceRunAfter)</code></td>
<td>退出应用并安装更新</td>
</tr>
</tbody></table>
<h4 id="提供的事件"><a href="#提供的事件" class="headerlink" title="提供的事件"></a>提供的事件</h4><p><a target="_blank" rel="noopener" href="https://www.electron.build/auto-update#events">文档</a></p>
<table>
<thead>
<tr>
<th>事件</th>
<th>触发</th>
</tr>
</thead>
<tbody><tr>
<td>error</td>
<td>更新错误</td>
</tr>
<tr>
<td>checking-for-update</td>
<td>检查更新中</td>
</tr>
<tr>
<td>update-available</td>
<td>有可用更新</td>
</tr>
<tr>
<td>update-not-available</td>
<td>没有可用更新</td>
</tr>
<tr>
<td>download-progress</td>
<td>下载更新中</td>
</tr>
<tr>
<td>update-downloaded</td>
<td>更新下载完成</td>
</tr>
</tbody></table>
<h4 id="一个简单的更新示例"><a href="#一个简单的更新示例" class="headerlink" title="一个简单的更新示例"></a>一个简单的更新示例</h4><p>在主进程监听检查更新事件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; autoUpdater &#125; <span class="keyword">from</span> <span class="string">&#x27;electron-updater&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ipcMain &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span></span><br><span class="line"></span><br><span class="line">ipcMain.on(<span class="string">&#x27;CHECK_FOR_UPDATE&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  autoUpdater.checkForUpdatesAndNotify()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在渲染进程点击按钮发送ipc事件检查更新(以React为例)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import React from &#39;react&#39;;</span><br><span class="line">import &#123; ipcRenderer &#125; from &#39;electron&#39;</span><br><span class="line">import &#39;.&#x2F;App.css&#39;;</span><br><span class="line"></span><br><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div className&#x3D;&quot;App&quot;&gt;</span><br><span class="line">      &lt;button onClick&#x3D;&#123;ipcRenderer.send(&#39;CHECK_FOR_UPDATE&#39;)&#125;&gt;检查更新&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default App;</span><br></pre></td></tr></table></figure>

<p>注意创建BrowserWindow时需要设置webPreferences属性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">window</span> = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">  webPreferences: &#123;</span><br><span class="line">    webSecurity: <span class="literal">false</span>,</span><br><span class="line">    nodeIntegration: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="更新服务的设计"><a href="#更新服务的设计" class="headerlink" title="更新服务的设计"></a>更新服务的设计</h3><p>上面寥寥几行代码就实现了一个简单的更新功能，但是这个功能在复杂的业务场景中往往没有那么适合，因此我们在这里开始来设计一个贴合常见场景的更新方案。</p>
<h4 id="需要实现的功能"><a href="#需要实现的功能" class="headerlink" title="需要实现的功能"></a>需要实现的功能</h4><ol>
<li>查看更新信息</li>
<li>用户手动检查更新;</li>
<li>应用启动时静默检查更新;</li>
<li>应用在后台定时检查更新;</li>
<li>用户手动下载更新;</li>
<li>下载进度显示;</li>
<li>用户手动退出安装更新;</li>
<li>通过版本号控制强制更新; </li>
<li>日志;</li>
<li>开发时请求本地服务做测试;</li>
</ol>
<h4 id="更新流程"><a href="#更新流程" class="headerlink" title="更新流程"></a>更新流程</h4><p>更新过程的所有状态:</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Idle</td>
<td>空闲</td>
</tr>
<tr>
<td>Checking</td>
<td>检查中</td>
</tr>
<tr>
<td>Available</td>
<td>有可下载更新</td>
</tr>
<tr>
<td>Downloading</td>
<td>下载中</td>
</tr>
<tr>
<td>Downloaded</td>
<td>下载完成</td>
</tr>
</tbody></table>
<p>状态流程如图</p>
<p><img src= "/img/loading.gif" data-lazy-src="http://mei160.cn/images/auto_update_workflow.png" alt="auto update workflow"></p>
<h4 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h4><p>根据上述功能，对更新服务做一个初步的设计</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/updater.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; autoUpdater, UpdateInfo &#125; <span class="keyword">from</span> <span class="string">&#x27;electron-updater&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> CheckResult&#123;</span><br><span class="line">  <span class="comment">// 是否有更新</span></span><br><span class="line">  available: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// 更新内容</span></span><br><span class="line">  updateInfo: UpdateInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> ProgressInfo &#123;</span><br><span class="line">  total: <span class="built_in">number</span></span><br><span class="line">  delta: <span class="built_in">number</span></span><br><span class="line">  transferred: <span class="built_in">number</span></span><br><span class="line">  percent: <span class="built_in">number</span></span><br><span class="line">  bytesPerSecond: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下载进度回调</span></span><br><span class="line"><span class="keyword">type</span> DownloadProgressCallback = <span class="function">(<span class="params">p: ProgressInfo</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line"><span class="comment">// 下载结束回调</span></span><br><span class="line"><span class="keyword">type</span> DownloadedCallback = <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> AppUpdateService &#123;</span><br><span class="line">  <span class="comment">// 检查更新</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> checkUpdate(): CheckResult</span><br><span class="line">  <span class="comment">// 下载更新</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> downloadUpdate(params: &#123;onDownloadProgress: DownloadProgressCallback, onDownloaded: DownloadedCallback &#125;): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 应用更新</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> applyUpdate(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是由于ipc通信的限制，无法传递回调函数，因此我们在这里考虑将更新服务的业务功能封装都移到渲染进程，主进程只提供基本的初始化服务和接口方法的封装。</p>
<p><code>app/updater.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; autoUpdater &#125; <span class="keyword">from</span> <span class="string">&quot;electron-updater&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">&quot;electron-log&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserWindow, ipcMain, app &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> autoUpdater.checkForUpdates();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> autoUpdater.downloadUpdate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> autoUpdater.quitAndInstall();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendToAllBrowserWindows</span>(<span class="params">channel: <span class="built_in">string</span>, ...args: unknown[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> browserWindows = BrowserWindow.getAllWindows()</span><br><span class="line">  browserWindows.forEach(<span class="function"><span class="params">bw</span>=&gt;</span>bw.webContents.send(channel, ...args))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 日志</span></span><br><span class="line">  logger.transports.file.level = <span class="string">&quot;info&quot;</span>;</span><br><span class="line">  autoUpdater.logger = logger;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 禁用自动下载</span></span><br><span class="line">  autoUpdater.autoDownload = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 启用退出app时自动安装更新</span></span><br><span class="line">  autoUpdater.autoInstallOnAppQuit = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听事件并发送到渲染进程</span></span><br><span class="line">  <span class="keyword">const</span> events = [</span><br><span class="line">    <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    <span class="string">&quot;checking-for-update&quot;</span>,</span><br><span class="line">    <span class="string">&quot;update-available&quot;</span>,</span><br><span class="line">    <span class="string">&quot;update-not-available&quot;</span>,</span><br><span class="line">    <span class="string">&quot;download-progress&quot;</span>,</span><br><span class="line">    <span class="string">&quot;update-downloaded&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line">  events.forEach(<span class="function">(<span class="params">eventName</span>) =&gt;</span> autoUpdater.on(eventName, sendToAllBrowserWindows.bind(<span class="literal">null</span>, <span class="string">&#x27;APP_UPDATER/STATUS_CHANGE&#x27;</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过接收渲染进程发送的ipc调用方法</span></span><br><span class="line">  ipcMain.on(<span class="string">&#x27;APP_UPDATER/CHECK_UPDATE&#x27;</span>, checkUpdate)</span><br><span class="line">  ipcMain.on(<span class="string">&#x27;APP_UPDATER/DOWNLOAD_UPDATE&#x27;</span>, downloadUpdate)</span><br><span class="line">  ipcMain.on(<span class="string">&#x27;APP_UPDATER/APPLY_UPDATE&#x27;</span>, applyUpdate)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.once(<span class="string">&#x27;will-finish-launching&#x27;</span>, init)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AppUpdater = &#123;</span><br><span class="line">  checkUpdate,</span><br><span class="line">  downloadUpdate,</span><br><span class="line">  applyUpdate,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在渲染进程，我们首先创建一个自定义hooks来实现接收更新状态变更并通过<code>createContext</code>来实现组件状态共享。<br><code>renderer/src/Hooks/useAppUpdate.js</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect, useContext, createContext &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ipcRenderer &#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useAppUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [status, setStatus] = useState(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [updateInfo, setUpdateInfo] = useState(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [updateProgressInfo, setUpdateProgressInfo] = useState(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> checkUpdate = <span class="function">() =&gt;</span> ipcRenderer.send(<span class="string">&#x27;APP_UPDATER/CHECK_UPDATE&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> downloadUpdate = <span class="function">() =&gt;</span> ipcRenderer.send(<span class="string">&#x27;APP_UPDATER/DOWNLOAD_UPDATE&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> applyUpdate = <span class="function">() =&gt;</span> ipcRenderer.send(<span class="string">&#x27;APP_UPDATER/APPLY_UPDATE&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ipcRenderer.on(<span class="string">&quot;APP_UPDATER/STATUS_CHANGE&quot;</span>, <span class="function">(<span class="params">event, updateEventName, ...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`updater#<span class="subst">$&#123;updateEventName&#125;</span>: `</span>, ...args);</span><br><span class="line"></span><br><span class="line">        setStatus(updateEventName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (updateEventName) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;error&quot;</span>:</span><br><span class="line">            setError(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;checking-for-update&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;update-available&quot;</span>:</span><br><span class="line">            setUpdateInfo(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;update-not-available&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;download-progress&quot;</span>:</span><br><span class="line">            setUpdateProgressInfo(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;update-downloaded&quot;</span>:</span><br><span class="line">            setUpdateInfo(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; </span><br><span class="line">    status, updateInfo, updateProgressInfo, error, </span><br><span class="line">    checkUpdate, downloadUpdate, applyUpdate,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UpdaterContext = createContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UpdaterProvider = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> state = useAppUpdate();</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">UpdaterContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;state&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">UpdaterContext.Provider</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useUpdaterContext</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> store = useContext(UpdaterContext)</span><br><span class="line">  <span class="keyword">return</span> store</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个AboutPanel组件，在组件中显示更新信息下载进度，已经更新按钮等<br><code>renderer/src/Components/AboutPanel/index.jsx</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;useMemo&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useUpdaterContext &#125; <span class="keyword">from</span> <span class="string">&#x27;../../Hooks/useAppUpdate&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">AboutPanel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; </span><br><span class="line">    status, updateInfo, updateProgressInfo, error, </span><br><span class="line">    checkUpdate, downloadUpdate, applyUpdate,</span><br><span class="line">   &#125; = useUpdaterContext()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> Button = useMemo(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(status === <span class="string">&#x27;update-available&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;downloadUpdate&#125;</span>&gt;</span>Download Updates<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(status === <span class="string">&#x27;download-progress&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>Downloading...<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(status === <span class="string">&#x27;update-downloaded&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;applyUpdate&#125;</span>&gt;</span>Apply Updates<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;checkUpdate&#125;</span>&gt;</span>Check for Updates<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">   &#125;, [status])</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> Info = useMemo(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(status === <span class="string">&#x27;error&#x27;</span>)&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&#x27;error&#x27;</span>,error)</span><br><span class="line">       <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;&gt;</span> </span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&#123;&#123;color:</span> &#x27;<span class="attr">lightpink</span>&#x27;&#125;&#125;&gt;</span>&#123;error?.name&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&#123;&#123;color:</span> &#x27;<span class="attr">lightpink</span>&#x27;&#125;&#125;&gt;</span>&#123;error?.message&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&#123;&#123;color:</span> &#x27;<span class="attr">lightpink</span>&#x27;&#125;&#125;&gt;</span>&#123;error?.stack&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(status === <span class="string">&#x27;checking-for-update&#x27;</span>)&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Checking...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">    <span class="keyword">if</span>(status ===<span class="string">&#x27;update-not-available&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>No Updates Available<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(updateInfo)&#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;version, releaseName, releaseNotes, releaseDate&#125; = updateInfo</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>version: &#123;version&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>date: &#123;releaseDate&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>name: &#123;releaseName&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>notes: &#123;releaseNotes&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">   &#125;, [status, updateInfo, error])</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123;Info&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">      &#123;</span></span><br><span class="line"><span class="xml">        status === &#x27;download-progress&#x27; &amp;&amp; Boolean(updateProgressInfo) &amp;&amp; </span></span><br><span class="line">        &lt;div style=&#123;&#123;backgroundColor: &#x27;grey&#x27;, width: 300, height: 20, margin: &#x27;12px auto&#x27;&#125;&#125;&gt;</span><br><span class="line">          &lt;div style=&#123;&#123;backgroundColor: &#x27;cornflowerblue&#x27;, height: 20, width: 300 * updateProgressInfo.percent / 100&#125;&#125;&gt;&lt;/div&gt;</span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">      &#123;Button&#125;</span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建一个UpdateChecker组件，在这个组件中做静默检查、定时检查和更新提示<br><code>renderer/src/Components/UpdateChecker/index.jsx</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useAppUpdate &#125; <span class="keyword">from</span> <span class="string">&#x27;../../Hooks/useAppUpdate&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">UpdateChecker</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;checkUpdate, downloadUpdate, applyUpdate, updateInfo, status, updateProgressInfo&#125; = useAppUpdate()</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> timeout</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">scheduleCheckUpdate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(![<span class="string">&#x27;checking-for-update&#x27;</span>, <span class="string">&#x27;update-available&#x27;</span>, <span class="string">&#x27;download-progress&#x27;</span>, <span class="string">&#x27;update-downloaded&#x27;</span>].includes(status))&#123;</span><br><span class="line">        checkUpdate()</span><br><span class="line">      &#125;</span><br><span class="line">      timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        scheduleCheckUpdate()</span><br><span class="line">      &#125;, <span class="number">1000</span> * <span class="number">60</span> *<span class="number">60</span>);  </span><br><span class="line">    &#125;</span><br><span class="line">    scheduleCheckUpdate()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearTimeout</span>(timeout)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(status === <span class="string">&#x27;update-available&#x27;</span>)&#123;</span><br><span class="line">		  <span class="comment">// eslint-disable-next-line no-restricted-globals</span></span><br><span class="line">      <span class="keyword">const</span> result = confirm(<span class="string">&#x27;Updates available, download instantly?&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span>(result)&#123;</span><br><span class="line">        downloadUpdate()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(status === <span class="string">&#x27;update-downloaded&#x27;</span>)&#123;</span><br><span class="line">		  <span class="comment">// eslint-disable-next-line no-restricted-globals</span></span><br><span class="line">      <span class="keyword">const</span> result = confirm(<span class="string">&#x27;Download completed, apply updates?&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span>(result)&#123;</span><br><span class="line">        applyUpdate()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [status])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个基本的自动更新服务就完成了</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">王美</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hard-workingrookie.github.io/2021/01/07/electron%E5%B7%A5%E7%A8%8B%E5%8C%96/">https://hard-workingrookie.github.io/2021/01/07/electron%E5%B7%A5%E7%A8%8B%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hard-workingrookie.github.io" target="_blank">王美的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/electron/">electron</a></div><div class="post_share"><div class="social-share" data-image="http://tvshow.date/images/1504170750981724.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.jpg"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.jpg"/></a><div class="post-qr-code-desc"></div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/07/electron%E5%BA%94%E7%94%A8/"><img class="prev-cover" data-lazy-src="http://tvshow.date/images/1504170750981724.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">electron应用</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/29/react-ts%E5%AD%A6%E4%B9%A0%E9%A1%B9%E7%9B%AE%E5%8F%8A%E7%AC%94%E8%AE%B0/"><img class="next-cover" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">react+ts学习项目及笔记</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/01/07/electron窗口管理/" title="electron窗口管理"><img class="relatedPosts_cover" data-lazy-src="http://tvshow.date/images/1504170750981724.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-07</div><div class="relatedPosts_title">electron窗口管理</div></div></a></div><div class="relatedPosts_item"><a href="/2021/01/07/electron应用/" title="electron应用"><img class="relatedPosts_cover" data-lazy-src="http://tvshow.date/images/1504170750981724.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-07</div><div class="relatedPosts_title">electron应用</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(http://tvshow.date/images/1504170750981724.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 王美</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,  welcome  to  my  <a  href="https://hard-workingrookie.github.io/">blog</a>!</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: '',
      appKey: '',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/third-party/click_heart.js" async="async"></script></div></body></html>